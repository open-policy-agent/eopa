name: Benchmarks

on:
  push:
    branches: [ main ]

permissions:
  # contents permission to update benchmark contents in 'benchmarks' branch
  contents: write

jobs:
  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-22.04
    environment: ci
    env:
      GH_API_TOKEN: ${{ secrets.GH_API_TOKEN }}
    steps:
      - uses: actions/setup-go@v3
        with:
          go-version: '1.19'
          check-latest: true
      - name: Setup github api token
        run: git config --global url.https://$GH_API_TOKEN@github.com/.insteadOf https://github.com/
      - name: Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          path: load
      - name: Check out "benchmarks" branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: benchmarks
          path: benchmarks
      - uses: open-policy-agent/setup-opa@v2 # needed for below
      - name: pick up OPA version
        id: load
        run: echo "opa_version=v$(build/get-opa-version.sh)" >> $GITHUB_OUTPUT
        working-directory: load
      - name: checkout OPA
        uses: actions/checkout@v3
        with:
          repository: open-policy-agent/opa
          ref: ${{ steps.load.outputs.opa_version }}
          path: opa
      - name: pick up OPA directory
        id: opa
        working-directory: opa
        run: echo "dir=$(pwd)" >> $GITHUB_OUTPUT
      - name: Run benchmarks
        run: go test -run=^$ -bench=. -benchmem ./... | tee bench.out
        working-directory: load
        env:
          OPA_ROOT: ${{ steps.opa.outputs.dir }}
      - name: Merge results into "benchmarks" branch
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Go Benchmarks
          tool: go
          output-file-path: load/bench.out
          github-token: ${{ secrets.GH_API_TOKEN }}
          alert-threshold: '150%' # Show alert with commit comment on detecting possible performance regression
          comment-on-alert: true
          fail-on-alert: true
          external-data-json-path: benchmarks/benchmark-data.json
          alert-comment-cc-users: '@srenatus'
      - name: Push benchmark result
        run: |
          git config user.name benchmarks-updater
          git config user.email benchmarks-updater@styra.com
          git add benchmark-data.json
          git commit -sm "benchmark-data.json: update"
          git push benchmarks:benchmarks
        working-directory: benchmarks