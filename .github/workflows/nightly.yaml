name: Nightly
on:
  workflow_dispatch: {}   # Allow for manual triggers
  schedule:
    - cron:  '0 8 * * 1-5'  # Mo-Fr, at 8:00 UTC

env:
  GO_VERSION: 1.21
  BB_VERSION: 1.3.186

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-22.04
    environment: ci
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_ID }}
          private_key: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_PEM_KEY }}
      - name: Override GH Token Env Var
        run: echo "GH_API_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
      - uses: open-policy-agent/setup-opa@v2
      - name: checkout Enterprise OPA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: enterprise-opa
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: enterprise-opa/go.sum
          check-latest: true
      - name: Setup github api token
        run: git config --global url.https://git:$GH_API_TOKEN@github.com/StyraInc.insteadOf https://github.com/StyraInc
      - uses: ko-build/setup-ko@v0.6
      - name: Build
        run: make build
        working-directory: enterprise-opa
      - name: Upload image tarball
        uses: actions/upload-artifact@v3
        with:
          name: image
          path: enterprise-opa/local.tar
      - name: pick up eopa data
        id: enterprise-opa
        run: |
          echo "opa_version=v$(build/get-opa-version.sh)" >> $GITHUB_OUTPUT
          echo "image=$(docker load --quiet --input local.tar | awk '{print $3}')" >> $GITHUB_OUTPUT
          echo "bundles=$(pwd)/e2e" >> $GITHUB_OUTPUT
        working-directory: enterprise-opa
      - name: setup testcontainers-go properties
        run: cp -v testcontainers.properties ~/.testcontainers.properties
        working-directory: enterprise-opa
      - name: pick up paths
        id: paths
        run: |
          echo "fetchdb=$(pwd)/_fetchdb" >> $GITHUB_OUTPUT
          echo "opa_dir=$(pwd)/opa" >> $GITHUB_OUTPUT
      - name: checkout OPA
        uses: actions/checkout@v4
        with:
          repository: open-policy-agent/opa
          ref: ${{ steps.enterprise-opa.outputs.opa_version }}
          path: opa
      - run: make test-race
        working-directory: enterprise-opa
        env:
          OPA_ROOT: ${{ steps.paths.outputs.opa_dir }}
      - name: checkout opa-testing-e2e
        uses: actions/checkout@v4
        with:
          repository: StyraInc/opa-testing-e2e
          path: _e2e
          token: ${{ steps.generate_token.outputs.token }}
          persist-credentials: false
      - name: run "opa-testing-e2e"
        run: make test
        working-directory: _e2e
        env:
          EOPA_LICENSE_TOKEN: ${{ secrets.STYRA_LOAD_LICENSE_TOKEN }}
          IMAGE: ${{ steps.enterprise-opa.outputs.image }}
          BUNDLES: ${{ steps.enterprise-opa.outputs.bundles }}
          BUNDLE_FILE_PATH: bundles/systems/bc01d50d17d7446684c4e6c34a1ad07f
          NUM_INPUT_BUNDLES: 2
          BUNDLE_HOST: 172.17.0.1
      - name: Check out fetchdb code
        uses: actions/checkout@v4
        with:
          path: _fetchdb
          repository: StyraInc/fetchdb
          token: ${{ steps.generate_token.outputs.token }}
          persist-credentials: false
      - name: Run enterprise-opa-test (fetchdb)
        run: |
          sed -i 's#ghcr.io/styrainc/.*:latest#${{ steps.enterprise-opa.outputs.image  }}#' ${{ steps.paths.outputs.fetchdb}}/Makefile
          cd enterprise-opa/e2e && go test -tags e2e_fetchdb ./fetchdb
        env:
          FETCHDB_DIRECTORY: ${{ steps.paths.outputs.fetchdb }}

  goreleaser:
    name: GoReleaser
    runs-on: ubuntu-22.04
    environment: ci
    env:
      QUILL_SIGN_P12: ${{ secrets.QUILL_SIGN_P12 }} # base64 encoded contents
      QUILL_SIGN_PASSWORD: ${{ secrets.QUILL_SIGN_PASSWORD }} # p12 password
      QUILL_NOTARY_KEY: ${{ secrets.QUILL_NOTARY_KEY }}
      QUILL_NOTARY_KEY_ID: ${{ secrets.QUILL_NOTARY_KEY_ID }}
      QUILL_NOTARY_ISSUER: ${{ secrets.QUILL_NOTARY_ISSUER }}
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_ID }}
          private_key: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_PEM_KEY }}
      - name: Override GH Token Env Var
        run: echo "GH_API_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
      - uses: open-policy-agent/setup-opa@v2
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
      - name: setup github api token
        run: git config --global url.https://git:$GH_API_TOKEN@github.com/.insteadOf https://github.com/
      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          install-only: true
      - name: Install anchore/quill (macos signing)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/quill/main/install.sh |\
          sh -s -- -b /usr/local/bin
      - name: Make GoReleaser
        run: make release
        env:
          HOSTNAME: github.actions.local
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
      - name: Upload release artifacts
        uses: actions/upload-artifact@v3
        with:
          name: binaries
          path: |
            dist/checksums.txt
            dist/*build_*/*

  cross-build:
    name: Cross Build
    runs-on: ubuntu-22.04
    environment: ci
    strategy:
      fail-fast: true
      matrix:
        include:
          - GOOS: linux
            GOARCH: amd64
          - GOOS: linux
            GOARCH: arm64
          - GOOS: darwin
            GOARCH: amd64
          - GOOS: windows
            GOARCH: amd64
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_ID }}
          private_key: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_PEM_KEY }}
      - name: Override GH Token Env Var
        run: echo "GH_API_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
      - name: setup github api token
        run: git config --global url.https://git:$GH_API_TOKEN@github.com/.insteadOf https://github.com/
      - name: Check out code
        uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
      - uses: turtlequeue/setup-babashka@v1.5.2
        with:
          babashka-version: ${{ env.BB_VERSION }}
      - run: bb build/cross-build
        env:
          TESTDIR: test/${{ matrix.GOOS }}_${{ matrix.GOARCH }}
          GOOS: ${{ matrix.GOOS }}
          GOARCH: ${{ matrix.GOARCH }}
      - name: Upload test binaries
        uses: actions/upload-artifact@v3
        with:
          name: test-binaries
          path: test

  cross-test-releases:
    name: Cross Test Releases
    runs-on: ${{ matrix.os }}
    needs:
    - goreleaser
    - cross-build
    environment: ci
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            reldir: dist/linux-windows-build_linux_amd64_v1
            testdir: test/linux_amd64
          - os: ubuntu-22.04
            reldir: dist/linux-windows-build_linux_arm64
            testdir: test/linux_arm64
            arch: arm64
          - os: macos-latest
            reldir: dist/darwin-build_darwin_amd64_v1
            testdir: test/darwin_amd64
          - os: windows-latest
            reldir: dist/linux-windows-build_windows_amd64_v1
            testdir: test/windows_amd64
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
        if: matrix.arch == 'arm64'
      - name: Download release binaries
        uses: actions/download-artifact@v3
        with:
          name: binaries
          path: dist
      - name: Download test binaries
        uses: actions/download-artifact@v3
        with:
          name: test-binaries
          path: test
      - uses: turtlequeue/setup-babashka@v1.5.2
        with:
          babashka-version: ${{ env.BB_VERSION }}
      - run: bb ${{ matrix.testdir }}/cross-run
        env:
          TESTDIR: ${{ matrix.testdir }}
          RELDIR: ${{ matrix.reldir }}
          EOPA_LICENSE_TOKEN: ${{ secrets.STYRA_LOAD_LICENSE_TOKEN }}

  regal:
    name: Regal e2e
    runs-on: ubuntu-22.04
    environment: ci
    steps:
      - uses: open-policy-agent/setup-opa@v2
      - name: checkout Enterprise OPA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: enterprise-opa
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: enterprise-opa/go.sum
          check-latest: true
      - name: Build and E2E
        run: |
          go mod tidy
          go build -o regal main.go
          REGAL_BIN=$(pwd)/regal go test -tags e2e github.com/styrainc/regal/e2e -v -skip 'TestTestRegalBundledBundle|TestLintPprof'
        working-directory: enterprise-opa/examples/regal
        env:
          GOPRIVATE: github.com/styrainc/

  trivy-scan-image:
    name: Trivy security scan image
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: Checkout code # needed for .trivyignore file
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download image tarball
        uses: actions/download-artifact@v3
        with:
          name: image
      - name: Enterprise OPA image
        id: enterprise-opa
        run: echo "image=$(docker load --quiet --input local.tar | awk '{print $3}')" >> $GITHUB_OUTPUT
        # Equivalent to:
        # $ trivy image $IMAGE
      - name: Run Trivy scan on image
        uses: aquasecurity/trivy-action@0.15.0
        with:
          image-ref: ${{ steps.enterprise-opa.outputs.image }}
          format: table
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH

  trivy-scan-repo:
    name: Trivy security scan repo
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Equivalent to:
      # $ trivy fs .
      - name: Run Trivy scan on repo
        uses: aquasecurity/trivy-action@0.15.0
        with:
          scan-type: fs
          format: table
          exit-code: '1'
          ignore-unfixed: true
          severity: CRITICAL,HIGH

  govulncheck:
    name: Go vulnerability check
    runs-on: ubuntu-22.04
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_ID }}
          private_key: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_PEM_KEY }}
      - name: Override GH Token Env Var
        run: echo "GH_API_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
      - name: setup github token
        run: git config --global url.https://git:$GH_API_TOKEN@github.com/StyraInc.insteadOf https://github.com/StyraInc
      - run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - run: govulncheck -tags use_opa_fork ./...

  fuzzer:
    name: Go Fuzzer
    runs-on: ubuntu-22.04
    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_ID }}
          private_key: ${{ secrets.PLATFORM_AUTOMATION_GH_APP_PEM_KEY }}
      - name: Override GH Token Env Var
        run: echo "GH_API_TOKEN=${{ steps.generate_token.outputs.token }}" >> $GITHUB_ENV
      - name: Check out code
        uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
      - name: setup github token
        run: git config --global url.https://git:$GH_API_TOKEN@github.com/StyraInc.insteadOf https://github.com/StyraInc
      - run: make fuzz
      - name: Dump crashers
        if: ${{ failure() }}
        run: |
          cd pkg/json/testdata/fuzz
          git add -A
          git diff HEAD

  analyze:
    name: CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: go

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:go"
