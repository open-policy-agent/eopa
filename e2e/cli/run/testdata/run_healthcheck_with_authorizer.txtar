# This test ensures that any default-registered plugins EOPA is using do
# not break basic health checks when the authorizer is enabled.
#
# NOTE: port 61658 was chosen at random, so that if we run in parallel with
# other tests, we won't fail to bind to the interface.
[windows] ! exec eopa run --log-level error --addr 127.0.0.1:61658 --server --authorization=basic example/system/authz.rego &eopa&
[!windows]  exec eopa run --log-level error --addr 127.0.0.1:61658 --server --authorization=basic example/system/authz.rego &eopa&
! stdout .
! stderr .

# Check that the server reports health OK
httpwait 'http://localhost:61658/health' '{}' 3
! stderr .

stop eopa
! stdout .
! stderr .

-- example/system/authz.rego --
package system.authz

import rego.v1

default allow := false

# Allow health checks through the authorizer.
allow if {
	input.path == ["health"]
}