# unset all license envs to trigger fallback mode
env EOPA_LICENSE_KEY=
env EOPA_LICENSE_TOKEN=

# we expect a nonzero exit code on windows
[windows] ! exec eopa run --log-level error --addr 127.0.0.1:61596 --server --bundle bundledir &eopa&
[!windows]  exec eopa run --log-level error --addr 127.0.0.1:61596 --server --bundle bundledir &eopa&
! stdout .
! stderr .

# block until the server reports health OK
httpwait 'http://localhost:61596/health' '{}'

exec curl -Ss --request GET --url http://localhost:61596/v1/data/foo
! stderr .
cmp stdout exp/stdout

stop eopa
! stdout .
stderr 'no license provided'
stderr 'Switching to OPA mode'

-- bundledir/data.json --
{"foo": "bear"}
-- exp/stdout --
{"result":"bear"}
