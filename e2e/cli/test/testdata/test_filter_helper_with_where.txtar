exec eopa test .
! stderr .
cmp stdout exp/stdout

-- filters.rego --
package filters

# METADATA
# scope: document
# compile:
#   unknowns: ["input.fruits", "input.users"]
include if input.users.name == input.username
-- filters_test.rego --
package filters

import data.system.eopa.utils.tests.v1.filter

fruits_table := [
	{"id": 0, "name": "apple", "owner_id": "a"},
	{"id": 1, "name": "banana", "owner_id": "a"},
	{"id": 2, "name": "cherry", "owner_id": "b"},
]

users_table := [
	{"id": "a", "name": "jane"},
	{"id": "b", "name": "john"},
]

test_owner_can_see_their_fruit_excluding_applets if {
	filtered := filter.helper(
		"data.filters.include",
		"SELECT fruits.name, users.name as owner FROM fruits LEFT JOIN users ON fruits.owner_id = users.id WHERE fruits.name <> 'apple'",
		{
			"fruits": fruits_table,
			"users": users_table,
		},
		{"debug": true},
	) with input.username as "jane"
	count(filtered) == 1
	{"name": "banana", "owner": "jane"} in filtered
}
-- exp/stdout --
PASS: 1/1
