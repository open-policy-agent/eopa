# syncmock is used by all commands in this file
# it has to expect failure (the "!") because it's
# killed at the end of the process
! exec syncmock --port 9991 --cookie-file .styra-session &
[darwin] exec sleep 1

# prep some stale data:
mkdir act/libraries/lib00
mkdir act/libraries/lib02/envoy
cp exp/libraries/lib02/stale act/libraries/lib02/stale
cp exp/libraries/lib00/old act/libraries/lib00/old

# this file gets overwritten
cp exp/libraries/lib02/stale act/libraries/lib02/envoy/policy.rego

exec eopa pull
stderr '\[INFO\] Retrieving 2 libraries: lib01, lib02'
[!windows] stderr '\[WARNING\] Found these files that don''t currently exist in the remote location: libraries/lib00, libraries/lib02/stale.'
[windows]  stderr '\[WARNING\] Found these files that don''t currently exist in the remote location: libraries\\lib00, libraries\\lib02\\stale.'
stderr '\[WARNING\] If you were not expecting this message, please delete those files or run `eopa pull --force`'
! stdout .
exec diff -r exp act

exec eopa pull --force --log-level warn
! stderr .
! stdout .

exec diff -r exp-clean act

-- .styra-session --
opensesame

-- .styra.yaml --
url: http://127.0.0.1:9991
libraries: act

-- exp/.gitignore --
*
-- exp/libraries/lib00/old --
-- exp/libraries/lib02/envoy/policy.rego --
package libraries.lib02.envoy
import future.keywords
allow if true
-- exp/libraries/lib02/stale --
not in mock response
-- exp/libraries/lib02/token/data.json --
{"bearer_token":"testtoken"}
-- exp/libraries/lib02/thing/data.json --
{"data":{"one":{"foo":1},"two":{"foo":2}}}
-- exp-clean/.gitignore --
*
-- exp-clean/libraries/lib02/envoy/policy.rego --
package libraries.lib02.envoy
import future.keywords
allow if true
-- exp-clean/libraries/lib02/token/data.json --
{"bearer_token":"testtoken"}
-- exp-clean/libraries/lib02/thing/data.json --
{"data":{"one":{"foo":1},"two":{"foo":2}}}
