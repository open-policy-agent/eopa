[windows] skip 'no way to check this on windows'

env PATH=$WORK:$PATH
env HOME=$WORK
chmod 755 $WORK/open
chmod 755 $WORK/xdg-open
exec eopa login --url https://my.styra.com --timeout 1s --log-level debug
! stdout .
stderr '\[DEBUG\] Using session file'
[!windows] stderr $WORK/\.styra-session
stderr '\[INFO\] Successfully logged in'
! stderr '\[INFO\] POST'
stderr '\[DEBUG\] Wrote config to .styra.yaml'

# comparing against a file yields a diff because of a trailing newline
exec echo -n opensesame
cmp stdout .styra-session

# generates config file
cmp .styra.yaml exp/.styra.yaml


# retrying, config exists
exec eopa login --timeout 1s --log-level debug # not passing --url
stderr '\[DEBUG\] used config file'
[!windows] stderr $WORK/.styra.yaml
stderr '\[INFO\] Successfully logged in'
! stderr '\[DEBUG\] Wrote config to .styra.yaml' # not generated


-- open --
#!/bin/sh
export COOKIE=opensesame
loginmock "$*" &

-- xdg-open --
#!/bin/sh
export COOKIE=opensesame
loginmock "$*" &

-- exp/.styra.yaml --
# generated by `eopa login`
url: "https://my.styra.com"
