#!/usr/bin/env bb
(ns cross.run
  (:require [babashka.fs :as fs]
            [babashka.process :refer [shell]]))

;; put directory that this script resides in into PATH
(def bindir  (fs/canonicalize (fs/parent *file*)))
(def pathvar (if (fs/windows?) "Path" "PATH"))
(def extra   {pathvar (str bindir fs/path-separator (System/getenv "PATH"))})

(defn run-test [ts] (shell {:extra-env extra} ts "-test.v"))

(defn chmod+x [bin] (when (not (fs/windows?)) (fs/set-posix-file-permissions bin "rwxr--r--")))

(defn -main [& args]
  (run! chmod+x (fs/glob bindir "*"))
  (run! run-test (fs/glob bindir "*.test*")))

(when (= *file* (System/getProperty "babashka.file"))
  (apply -main *command-line-args*))
